name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Deploy to VPS with Docker
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          cd ${{ secrets.VPS_PROJECT_PATH }}

          # Pull latest code (sama seperti yang kamu lakukan manual)
          echo "🔄 Pulling latest code from GitHub..."
          git pull origin main

          # Masuk ke container app untuk migration (kalau ada perubahan DB)
          echo "🗄️ Running database migrations..."
          docker compose exec -T app php artisan migrate

          # Masuk ke container app untuk build assets (seperti yang kamu lakukan manual)
          echo "🏗️ Building frontend assets..."
          docker compose exec -T app npm run build

          # Laravel optimizations (opsional - bisa di-comment kalau tidak perlu)
          echo "⚡ Optimizing Laravel..."
          docker compose exec -T app php artisan config:cache
          docker compose exec -T app php artisan route:cache
          docker compose exec -T app php artisan view:cache

          echo "✅ Deployment completed successfully!"
