<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Keep-Alive Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #cce7ff; color: #004085; border: 1px solid #b8daff; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <h1>Session Keep-Alive Test Tool</h1>
    <p>Tool untuk testing session keep-alive mechanism dan memantau koneksi ke server.</p>

    <div class="stats">
        <div class="stat-card">
            <div>Total Pings</div>
            <div class="stat-number" id="totalPings">0</div>
        </div>
        <div class="stat-card">
            <div>Successful Pings</div>
            <div class="stat-number" id="successPings">0</div>
        </div>
        <div class="stat-card">
            <div>Failed Pings</div>
            <div class="stat-number" id="failedPings">0</div>
        </div>
        <div class="stat-card">
            <div>Success Rate</div>
            <div class="stat-number" id="successRate">0%</div>
        </div>
    </div>

    <div class="status info" id="status">
        Ready to test session keep-alive functionality
    </div>

    <div>
        <button onclick="startAutoTest()">Start Auto Test (5s interval)</button>
        <button onclick="stopAutoTest()">Stop Auto Test</button>
        <button onclick="manualPing()">Manual Ping</button>
        <button onclick="checkSessionInfo()">Check Session Info</button>
        <button onclick="testSessionActive()">Test Session Active</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div>
        <h3>Next Ping In:</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
        <div id="countdown">Not started</div>
    </div>

    <div>
        <h3>Activity Log:</h3>
        <div class="log" id="log"></div>
    </div>

    <script>
        let autoTestInterval = null;
        let countdownInterval = null;
        let nextPingTime = 0;
        let stats = {
            total: 0,
            success: 0,
            failed: 0
        };

        function updateStats() {
            document.getElementById('totalPings').textContent = stats.total;
            document.getElementById('successPings').textContent = stats.success;
            document.getElementById('failedPings').textContent = stats.failed;

            const rate = stats.total > 0 ? Math.round((stats.success / stats.total) * 100) : 0;
            document.getElementById('successRate').textContent = rate + '%';
        }

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;

            // Update status
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function getCsrfToken() {
            const token = document.querySelector('meta[name="csrf-token"]');
            if (!token) {
                // If no CSRF token in meta tag, try to get from cookie
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'XSRF-TOKEN') {
                        return decodeURIComponent(value);
                    }
                }
                return null;
            }
            return token.getAttribute('content');
        }

        async function manualPing() {
            log('Sending manual keep-alive ping...', 'info');
            stats.total++;
            updateStats();

            try {
                const csrfToken = getCsrfToken();
                if (!csrfToken) {
                    throw new Error('CSRF token not found. Please login first.');
                }

                const response = await fetch('/keep-alive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({
                        timestamp: Date.now(),
                        user_agent: navigator.userAgent,
                        page_url: window.location.href
                    }),
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    stats.success++;
                    log(`‚úÖ Keep-alive successful! Session ID: ${data.data.session_id}, Count: ${data.data.keep_alive_count}`, 'success');
                } else {
                    stats.failed++;
                    log(`‚ùå Keep-alive failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                stats.failed++;
                log(`‚ùå Keep-alive error: ${error.message}`, 'error');
            }

            updateStats();
        }

        async function checkSessionInfo() {
            log('Getting session information...', 'info');

            try {
                const response = await fetch('/session-info', {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    log(`üìä Session Info - User: ${data.data.user_email}, Role: ${data.data.user_role}, Lifetime: ${data.data.session_lifetime}min, Keep-alive count: ${data.data.keep_alive_count}`, 'success');
                } else {
                    log(`‚ùå Failed to get session info: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Session info error: ${error.message}`, 'error');
            }
        }

        async function testSessionActive() {
            log('Testing if session is active...', 'info');

            try {
                const response = await fetch('/session-test', {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (response.ok && data.authenticated) {
                    log(`‚úÖ Session is active! User: ${data.user.email} (${data.user.role})`, 'success');
                } else {
                    log(`‚ùå Session not active or expired`, 'error');
                }
            } catch (error) {
                log(`‚ùå Session test error: ${error.message}`, 'error');
            }
        }

        function startAutoTest() {
            if (autoTestInterval) {
                log('Auto test is already running', 'warning');
                return;
            }

            log('Starting auto test with 5 second interval...', 'info');

            // Initial ping
            manualPing();

            // Set up interval
            autoTestInterval = setInterval(manualPing, 5000);

            // Set up countdown
            nextPingTime = Date.now() + 5000;
            startCountdown();
        }

        function stopAutoTest() {
            if (autoTestInterval) {
                clearInterval(autoTestInterval);
                autoTestInterval = null;
                log('Auto test stopped', 'info');
            }

            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
                document.getElementById('countdown').textContent = 'Stopped';
                document.getElementById('progressBar').style.width = '0%';
            }
        }

        function startCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            countdownInterval = setInterval(() => {
                const now = Date.now();
                const remaining = Math.max(0, nextPingTime - now);
                const seconds = Math.ceil(remaining / 1000);

                document.getElementById('countdown').textContent = `${seconds} seconds`;

                // Update progress bar
                const progress = Math.max(0, 100 - (remaining / 5000 * 100));
                document.getElementById('progressBar').style.width = progress + '%';

                if (remaining <= 0) {
                    nextPingTime = now + 5000;
                }
            }, 100);
        }

        function clearLogs() {
            document.getElementById('log').textContent = '';
            stats = { total: 0, success: 0, failed: 0 };
            updateStats();
            log('Logs cleared', 'info');
        }

        // Initialize
        updateStats();
        log('Session Keep-Alive Test Tool loaded. Click "Manual Ping" to test or "Start Auto Test" for continuous testing.', 'info');

        // Check if user is logged in on page load
        window.addEventListener('load', () => {
            setTimeout(testSessionActive, 1000);
        });
    </script>
</body>
</html>
